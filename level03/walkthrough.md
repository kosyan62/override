# level03 walkthrough

Given 32-bit binary, lets take a look at the [decompiled version](source.c):

    int main(int argc, char** argv, char** envp)
    {
        srand(time(NULL));
        puts("***********************************");
        puts("*\t\tlevel03\t\t**");
        puts("***********************************");
        printf("Password:");
        int input;
        scanf("%d", &input);
        test(input, 322424845);
        return 0;
    }

In the main function there is a scanf call that reads an integer from stdin and the test function call with two arguments: number from the input and hardcoded `322424845` constant. Lets check the test function decompilation:

    int test(int input, int base)
    {
        int key = (base - input);
        int rc;
        switch (key)
        {
            case 1:
            case 2:
            case 3:
            case 4:
            case 5:
            case 6:
            case 7:
            case 8:
            case 9:
            case 16:
            case 17:
            case 18:
            case 19:
            case 20:
            case 21:
            {
                rc = decrypt(key);
                break;
            }
            default:
                rc = decrypt(rand());
        }
        return rc;
    }

This function subtracts from the hardcoded constant provided integer and based on the value it calls the decrypt function with different arguments.
If the generated by the subtraction of two arguments key is equal to 1-9 or 16-21 values then the decrypt function would be called with this key otherwise it would provide a random value as an argument.
Decompiled version of the decrypt function shrinks a lot and becomes more clear:

    int decrypt(char key)
    {
    unsigned int i; // [esp+20h] [ebp-28h]
    unsigned int size; // [esp+24h] [ebp-24h]
    char cipher[29]; // [esp+2Bh] [ebp-1Dh] BYREF

    strncpy(cipher, "Q}|u`sfg~sf{}|a3", 17);
    size = strlen(cipher);
    for (i = 0; i < size; ++i)
        cipher[i] ^= key;
    if (!strncmp(cipher, "Congratulations!", 17))
        return system("/bin/sh");
    else
        return puts("\nInvalid Password");
    }

Here we can see a cipher string that is being xored with the key byte by byte, if it mutates to the string "Congratulations!" after the loop then the system function will be called and we'll gain access to the level04 shell. This is is a really simple cipher that can be decrypted by applying every possible key to the cipher string.
Also we don't need to check 255 values since in the test function there are only 15 cases. To automate this process we wrote a simple C [program](Resources/script.c):

    #include <stdio.h>

    int main()
    {
        char *to_xor = "Q}|u`sfg~sf{}|a3";
        char new_str[17];
        printf("Checking all xors for numbers from 0 to 21\n");
        int i;
        int number = 0;

        new_str[16] = 0;
        while (number <= 21)
        {
            i = 0;
            while (to_xor[i] != 0)
            {
                new_str[i] = to_xor[i] ^ number;
                i++;
            }
            printf("String with num <%i>: %s\n", number, new_str);
            number++;
        }
    }

After compilation and execution we will get:

    $ gcc /tmp/main.c -o /tmp/level03_checker
    $ /tmp/level03_checker
    Checking all xors for numbers from 0 to 21
    String with num <0>: Q}|u`sfg~sf{}|a3
    String with num <1>: P|}targfrgz|}`2
    String with num <2>: S~wbqde|qdy~c1
    String with num <3>: R~vcped}pex~b0
    String with num <4>: Uyxqdwbczwbyxe7
    String with num <5>: Txypevcb{vc~xyd6
    String with num <6>: W{zsfu`axu`}{zg5
    String with num <7>: Vz{rgta`yta|z{f4
    String with num <8>: Yut}h{nov{nsuti;
    String with num <9>: Xtu|izonwzortuh:
    String with num <10>: [wvjylmtylqwvk9
    String with num <11>: Zvw~kxmluxmpvwj8
    String with num <12>: ]qpyljkrjwqpm?
    String with num <13>: \pqxm~kjs~kvpql>
    String with num <14>: _sr{n}hip}husro=
    String with num <15>: ^rszo|ihq|itrsn<
    String with num <16>: Amlepcvwncvkmlq#
    String with num <17>: @lmdqbwvobwjlmp"
    String with num <18>: Congratulations!
    String with num <19>: Bnofs`utm`uhnor 
    String with num <20>: Eihatgrsjgroihu'
    String with num <21>: Dhi`ufsrkfsnhit&

So the correct key is 18, now we need to input the right number to get this key after subtraction which is 322424845-18=322424827:

    $ ./level03 
    ***********************************
    *		level03		**
    ***********************************
    Password:322424827
    $ whoami
    level04
    $ cat /home/users/level04/.pass            
    kgv3tkEb9h2mLkRsPkXRfc2mHbjMxQzvb2FrgKkf

Profit!
